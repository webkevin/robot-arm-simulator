<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot Arm Coffee Maker Simulator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f4f8;
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        .left-panel, .right-panel {
            width: 50%;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .left-panel {
            border-right: 2px solid #ddd;
            background: white;
        }
        
        .header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .header h1 {
            font-size: 24px;
            color: #333;
        }
        
        .info-box {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .info-box p {
            margin: 5px 0;
        }
        
        .info-box code {
            background: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        
        textarea {
            flex: 1;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            border: 1px solid #ddd;
            border-radius: 8px;
            resize: none;
            margin-bottom: 15px;
        }
        
        textarea:focus {
            outline: none;
            border-color: #2196F3;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }
        
        .run-btn {
            background: #4caf50;
            color: white;
        }
        
        .run-btn:hover {
            background: #45a049;
        }
        
        .run-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .reset-btn {
            background: #666;
            color: white;
        }
        
        .reset-btn:hover {
            background: #555;
        }
        
        .console {
            flex: 1;
            background: #1e1e1e;
            color: #4caf50;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-y: auto;
        }
        
        .console-header {
            color: #888;
            margin-bottom: 10px;
        }
        
        .right-panel h2 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #333;
        }
        
        .canvas-container {
            flex: 1;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .status-panel {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
        }
        
        .status-panel h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #333;
        }
        
        .joint-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .joint-item {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
        }
        
        .joint-label {
            color: #666;
        }
        
        .joint-value {
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        
        .gripper-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            margin-top: 10px;
        }
        
        .status-open {
            color: #4caf50;
            font-weight: bold;
        }
        
        .status-closed {
            color: #f44336;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-panel">
            <div class="header">
                <h1>☕ Robot Arm Coffee Maker</h1>
            </div>
            
            <div class="info-box">
                <p><strong>Available Commands:</strong></p>
                <p><code>move_joints([j0,j1,j2,j3,j4,j5], speed=1)</code></p>
                <p><code>wait(seconds)</code></p>
                <p><code>gripper_close()</code> / <code>gripper_open()</code></p>
            </div>
            
            <textarea id="codeEditor"># Robot Arm Coffee Maker Program
# Control 6 joints: base, shoulder, elbow, wrist1, wrist2, gripper

# Move to home position
move_joints([0, 0, 0, 0, 0, 0], speed=2)
wait(1)

# Pick up cup
move_joints([45, -30, 60, -30, 0, 0], speed=2)
wait(1)
gripper_close()
wait(0.5)

# Move to coffee machine
move_joints([90, -20, 40, -20, 0, 0], speed=2)
wait(1)

# Position under dispenser
move_joints([90, -40, 70, -30, 0, 0], speed=2)
wait(2)

# Move to delivery position
move_joints([0, -20, 40, -20, 0, 0], speed=2)
wait(1)
gripper_open()
wait(0.5)

# Return home
move_joints([0, 0, 0, 0, 0, 0], speed=2)</textarea>
            
            <div class="button-group">
                <button class="run-btn" id="runBtn">▶ Run Program</button>
                <button class="reset-btn" id="resetBtn">⟲ Reset</button>
            </div>
            
            <div class="console">
                <div class="console-header">Console Output:</div>
                <pre id="consoleOutput">Ready to run...</pre>
            </div>
        </div>
        
        <div class="right-panel">
            <h2>3D Workspace Visualization</h2>
            
            <div class="canvas-container">
                <canvas id="robotCanvas" width="800" height="600"></canvas>
            </div>
            
            <div class="status-panel">
                <h3>Current Joint Angles:</h3>
                <div class="joint-grid" id="jointGrid"></div>
                <div class="gripper-status">
                    <span class="joint-label">Gripper:</span>
                    <span id="gripperStatus" class="status-open">OPEN</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let joints = [0, 0, 0, 0, 0, 0];
        let isRunning = false;
        let gripperClosed = false;
        let cupPosition = { x: 150, y: 300, held: false };
        let coffeeDispensed = false;

        // Elements
        const canvas = document.getElementById('robotCanvas');
        const ctx = canvas.getContext('2d');
        const codeEditor = document.getElementById('codeEditor');
        const consoleOutput = document.getElementById('consoleOutput');
        const runBtn = document.getElementById('runBtn');
        const resetBtn = document.getElementById('resetBtn');
        const jointGrid = document.getElementById('jointGrid');
        const gripperStatus = document.getElementById('gripperStatus');

        // Draw scene
        function drawScene() {
            const centerX = 400;
            const centerY = 400;

            ctx.clearRect(0, 0, 800, 600);

            // Background
            ctx.fillStyle = '#f0f4f8';
            ctx.fillRect(0, 0, 800, 600);

            // Grid
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 800; i += 40) {
                ctx.beginPath();
                ctx.moveTo(i, 0);
                ctx.lineTo(i, 600);
                ctx.stroke();
            }
            for (let i = 0; i <= 600; i += 40) {
                ctx.beginPath();
                ctx.moveTo(0, i);
                ctx.lineTo(800, i);
                ctx.stroke();
            }

            // Coffee machine
            ctx.fillStyle = '#8b4513';
            ctx.fillRect(550, 320, 80, 80);
            ctx.fillStyle = '#654321';
            ctx.fillRect(560, 300, 60, 20);
            ctx.fillStyle = '#d2691e';
            ctx.fillRect(575, 310, 30, 10);

            // Coffee stream
            if (coffeeDispensed) {
                ctx.strokeStyle = '#4a2511';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(590, 320);
                ctx.lineTo(590, 360);
                ctx.stroke();
            }

            // Cup (if not held)
            if (!cupPosition.held) {
                ctx.fillStyle = coffeeDispensed ? '#8b4513' : '#ffffff';
                ctx.strokeStyle = '#333333';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(cupPosition.x, cupPosition.y, 15, 0, Math.PI * 2);
                ctx.fill();
                ctx.stroke();
            }

            // Base
            ctx.fillStyle = '#555555';
            ctx.beginPath();
            ctx.arc(centerX, centerY, 30, 0, Math.PI * 2);
            ctx.fill();

            // Calculate arm positions
            const [base, shoulder, elbow, wrist1] = joints.map(a => a * Math.PI / 180);
            const l1 = 80, l2 = 80, l3 = 60;

            const x2 = l1 * Math.cos(shoulder);
            const y2 = l1 * Math.sin(shoulder);
            const x3 = x2 + l2 * Math.cos(shoulder + elbow);
            const y3 = y2 + l2 * Math.sin(shoulder + elbow);
            const x4 = x3 + l3 * Math.cos(shoulder + elbow + wrist1);
            const y4 = y3 + l3 * Math.sin(shoulder + elbow + wrist1);

            const rotatePoint = (x, y, angle) => ({
                x: x * Math.cos(angle) - y * Math.sin(angle),
                y: x * Math.sin(angle) + y * Math.cos(angle)
            });

            const p1 = { x: centerX, y: centerY };
            const p2 = rotatePoint(x2, y2, base);
            p2.x += centerX; p2.y = centerY - p2.y;
            const p3 = rotatePoint(x3, y3, base);
            p3.x += centerX; p3.y = centerY - p3.y;
            const p4 = rotatePoint(x4, y4, base);
            p4.x += centerX; p4.y = centerY - p4.y;

            // Draw links
            ctx.lineCap = 'round';
            
            ctx.strokeStyle = '#2196F3';
            ctx.lineWidth = 8;
            ctx.beginPath();
            ctx.moveTo(p1.x, p1.y);
            ctx.lineTo(p2.x, p2.y);
            ctx.stroke();

            ctx.strokeStyle = '#4CAF50';
            ctx.beginPath();
            ctx.moveTo(p2.x, p2.y);
            ctx.lineTo(p3.x, p3.y);
            ctx.stroke();

            ctx.strokeStyle = '#FF9800';
            ctx.beginPath();
            ctx.moveTo(p3.x, p3.y);
            ctx.lineTo(p4.x, p4.y);
            ctx.stroke();

            // Draw joints
            [p1, p2, p3, p4].forEach(p => {
                ctx.fillStyle = '#333333';
                ctx.beginPath();
                ctx.arc(p.x, p.y, 6, 0, Math.PI * 2);
                ctx.fill();
            });

            // Draw gripper
            const gripperAngle = shoulder + elbow + wrist1 + base;
            const gripperWidth = gripperClosed ? 8 : 20;
            
            ctx.strokeStyle = '#f44336';
            ctx.lineWidth = 4;
            
            const gx1 = p4.x + gripperWidth * Math.cos(gripperAngle + Math.PI/2);
            const gy1 = p4.y - gripperWidth * Math.sin(gripperAngle + Math.PI/2);
            const gx2 = p4.x - gripperWidth * Math.cos(gripperAngle + Math.PI/2);
            const gy2 = p4.y + gripperWidth * Math.sin(gripperAngle + Math.PI/2);
            
            ctx.beginPath();
            ctx.moveTo(p4.x, p4.y);
            ctx.lineTo(gx1, gy1);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(p4.x, p4.y);
            ctx.lineTo(gx2, gy2);
            ctx.stroke();

            // Draw held cup
            if (cupPosition.held) {
                ctx.fillStyle = coffeeDispensed ? '#8b4513' : '#ffffff';
                ctx.strokeStyle = '#333333';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(p4.x, p4.y, 15, 0, Math.PI * 2);
                ctx.fill();
                ctx.stroke();
                
                if (Math.abs(p4.x - 590) < 30 && Math.abs(p4.y - 360) < 30) {
                    coffeeDispensed = true;
                }
            }

            updateUI();
        }

        function updateUI() {
            // Update joint angles display
            const jointNames = ['Base', 'Shoulder', 'Elbow', 'Wrist1', 'Wrist2', 'Gripper'];
            jointGrid.innerHTML = jointNames.map((name, i) => `
                <div class="joint-item">
                    <span class="joint-label">${name}:</span>
                    <span class="joint-value">${joints[i].toFixed(1)}°</span>
                </div>
            `).join('');

            // Update gripper status
            gripperStatus.textContent = gripperClosed ? 'CLOSED' : 'OPEN';
            gripperStatus.className = gripperClosed ? 'status-closed' : 'status-open';
        }

        function calculateEndEffector(angles) {
            const [base, shoulder, elbow, wrist1] = angles.map(a => a * Math.PI / 180);
            const l1 = 80, l2 = 80, l3 = 60;
            
            const x2 = l1 * Math.cos(shoulder);
            const y2 = l1 * Math.sin(shoulder);
            const x3 = x2 + l2 * Math.cos(shoulder + elbow);
            const y3 = y2 + l2 * Math.sin(shoulder + elbow);
            const x4 = x3 + l3 * Math.cos(shoulder + elbow + wrist1);
            const y4 = y3 + l3 * Math.sin(shoulder + elbow + wrist1);
            
            const rotX = x4 * Math.cos(base) - y4 * Math.sin(base);
            const rotY = x4 * Math.sin(base) + y4 * Math.cos(base);
            
            return { x: 400 + rotX, y: 400 - rotY };
        }

        function animateJoints(targetAngles, speed) {
            return new Promise(resolve => {
                const startAngles = [...joints];
                const duration = 1000 / speed;
                const startTime = Date.now();

                function animate() {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    joints = startAngles.map((start, i) => 
                        start + (targetAngles[i] - start) * progress
                    );
                    
                    drawScene();

                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        resolve();
                    }
                }

                animate();
            });
        }

        async function executeCode() {
            if (isRunning) return;
            
            isRunning = true;
            runBtn.disabled = true;
            consoleOutput.textContent = 'Starting program...\n';
            coffeeDispensed = false;
            gripperClosed = false;
            cupPosition = { x: 150, y: 300, held: false };

            const code = codeEditor.value;
            const lines = code.split('\n').filter(line => {
                const trimmed = line.trim();
                return trimmed && !trimmed.startsWith('#');
            });

            for (const line of lines) {
                const trimmed = line.trim();
                
                if (trimmed.startsWith('move_joints')) {
                    const match = trimmed.match(/move_joints\(\[([-\d, ]+)\]/);
                    if (match) {
                        const angles = match[1].split(',').map(s => parseFloat(s.trim()));
                        const speedMatch = trimmed.match(/speed=([\d.]+)/);
                        const speed = speedMatch ? parseFloat(speedMatch[1]) : 1;
                        
                        await animateJoints(angles, speed);
                        consoleOutput.textContent += `Moved to position: [${angles.join(', ')}]\n`;
                    }
                } else if (trimmed.startsWith('wait')) {
                    const match = trimmed.match(/wait\(([\d.]+)\)/);
                    if (match) {
                        const duration = parseFloat(match[1]) * 1000;
                        await new Promise(resolve => setTimeout(resolve, duration));
                        consoleOutput.textContent += `Waited ${match[1]}s\n`;
                    }
                } else if (trimmed === 'gripper_close()') {
                    gripperClosed = true;
                    const endPos = calculateEndEffector(joints);
                    if (Math.abs(endPos.x - cupPosition.x) < 30 && Math.abs(endPos.y - cupPosition.y) < 30) {
                        cupPosition.held = true;
                        consoleOutput.textContent += 'Gripper closed - Cup picked up!\n';
                    } else {
                        consoleOutput.textContent += 'Gripper closed\n';
                    }
                    drawScene();
                    await new Promise(resolve => setTimeout(resolve, 500));
                } else if (trimmed === 'gripper_open()') {
                    gripperClosed = false;
                    if (cupPosition.held) {
                        const endPos = calculateEndEffector(joints);
                        cupPosition = { x: endPos.x, y: endPos.y, held: false };
                    }
                    consoleOutput.textContent += 'Gripper opened\n';
                    drawScene();
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }

            consoleOutput.textContent += '\nProgram completed!\n';
            isRunning = false;
            runBtn.disabled = false;
        }

        function reset() {
            isRunning = false;
            runBtn.disabled = false;
            joints = [0, 0, 0, 0, 0, 0];
            gripperClosed = false;
            cupPosition = { x: 150, y: 300, held: false };
            coffeeDispensed = false;
            consoleOutput.textContent = 'Ready to run...';
            drawScene();
        }

        // Event listeners
        runBtn.addEventListener('click', executeCode);
        resetBtn.addEventListener('click', reset);

        // Initial draw
        drawScene();
    </script>
</body>
</html>